package com.database.getlists;

import javax.naming.InitialContext;
import javax.naming.NamingException;
import javax.sql.DataSource;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@WebServlet(name = "VoucherViewer", urlPatterns = {"/voucherviewer"})
public class VoucherViewer extends HttpServlet {
    private DataSource dataSource;

    @Override
    public void init() throws ServletException {
        try {
            // Lookup the JNDI DataSource
            InitialContext ctx = new InitialContext();
            dataSource = (DataSource) ctx.lookup("java:comp/env/jdbc/dbServlet");
        } catch (NamingException e) {
            throw new ServletException("Failed to lookup JNDI DataSource", e);
        }
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException {
        response.setContentType("application/json");
        response.setCharacterEncoding("UTF-8");

        // SQL query to retrieve voucher data
        String sql = "SELECT Employee_ID, Date, Day, Emp_Name, Voucher_Amount, Tclock_ID, Reason FROM Voucher";

        // Prepare the response list
        List<Map<String, Object>> vouchers = new ArrayList<>();

        try (Connection conn = dataSource.getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql);
             ResultSet rs = stmt.executeQuery()) {

            // Parse the database result set
            while (rs.next()) {
                Map<String, Object> voucher = new HashMap<>();
                voucher.put("Employee_ID", rs.getLong("Employee_ID"));
                voucher.put("Date", rs.getString("Date"));
                voucher.put("Day", rs.getString("Day"));
                voucher.put("Emp_Name", rs.getString("Emp_Name"));
                voucher.put("Voucher_Amount", rs.getDouble("Voucher_Amount"));
                voucher.put("Tclock_ID", rs.getString("Tclock_ID"));
                voucher.put("Reason", rs.getString("Reason"));
                vouchers.add(voucher);
            }

            // Convert list to JSON and write the response
            response.getWriter().write(mapListToJson(vouchers));

        } catch (SQLException e) {
            e.printStackTrace();
            response.setStatus(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);
            response.getWriter().write("{\"error\":\"Database query failed.\"}");
        }
    }

    
    private String mapListToJson(List<Map<String, Object>> data) {
    StringBuilder json = new StringBuilder("[");
    for (int i = 0; i < data.size(); i++) {
        Map<String, Object> map = data.get(i);
        json.append("{");
        json.append("\"Employee_ID\":\"").append(escapeJson(map.get("Employee_ID").toString())).append("\",");
        json.append("\"Date\":\"").append(escapeJson(map.get("Date").toString())).append("\",");
        json.append("\"Day\":\"").append(escapeJson(map.get("Day").toString())).append("\",");
        json.append("\"Emp_Name\":\"").append(escapeJson(map.get("Emp_Name").toString())).append("\",");
        json.append("\"Voucher_Amount\":\"").append(map.get("Voucher_Amount")).append("\","); // Numbers donâ€™t need escaping
        json.append("\"Tclock_ID\":\"").append(escapeJson(map.get("Tclock_ID").toString())).append("\",");
        json.append("\"Reason\":\"").append(escapeJson(map.get("Reason").toString())).append("\"");
        json.append("}");
        if (i < data.size() - 1) {
            json.append(",");
        }
    }
    json.append("]");
    return json.toString();
}

private String escapeJson(String input) {
    if (input == null) {
        return ""; // null-safe handling
    }
    // Replace problematic characters with their escaped forms
    return input.replace("\\", "\\\\") // Escape backslashes
                .replace("\"", "\\\"") // Escape quotes
                .replace("\n", "\\n") // Escape newline
                .replace("\r", "\\r") // Escape carriage return
                .replace("\t", "\\t"); // Escape tabs
}
    
    
    
    